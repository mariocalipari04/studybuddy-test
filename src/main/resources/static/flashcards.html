<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards - AI Study Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .deck-color-bar {
            height: 6px;
            border-radius: 4px 4px 0 0;
        }
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: var(--text-primary);
        }
        .progress {
            height: 6px;
            background: var(--dark-border);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }
        /* Alert per topic dalla spiegazione */
        .topic-alert {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .topic-alert i {
            font-size: 1.5rem;
            color: #a78bfa;
        }
        .topic-alert-content {
            flex: 1;
        }
        .topic-alert-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.25rem;
        }
        .topic-alert-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
<!-- Sidebar e Topbar generati da layout.js -->

<main class="main-content">
    <div id="alertContainer"></div>

    <!-- Alert per topic dalla spiegazione -->
    <div id="topicFromExplanationAlert" class="topic-alert" style="display: none;">
        <i class="bi bi-lightbulb-fill"></i>
        <div class="topic-alert-content">
            <div class="topic-alert-title">Crea flashcards da una spiegazione</div>
            <div class="topic-alert-text" id="topicAlertText">Argomento: ...</div>
        </div>
        <button class="btn btn-primary btn-sm" id="createFromTopicBtn">
            <i class="bi bi-plus-lg"></i> Crea Deck
        </button>
        <button class="btn btn-outline btn-sm" onclick="dismissTopicAlert()">
            <i class="bi bi-x"></i>
        </button>
    </div>

    <!-- Decks List View -->
    <div id="decksView">
        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-value" id="statTotalDecks">0</div>
                <div class="stat-label">Deck Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTotalCards">0</div>
                <div class="stat-label">Flashcards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statMastered">0</div>
                <div class="stat-label">Padroneggiate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statStudySessions">0</div>
                <div class="stat-label">Sessioni Studio</div>
            </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 1.5rem;">
            <button class="btn btn-primary" onclick="showCreateDeckModal()">
                <i class="bi bi-plus-lg"></i>
                Nuovo Deck
            </button>
        </div>

        <!-- Decks Grid -->
        <div id="decksGrid" class="deck-grid">
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <div class="loading-spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: var(--text-muted);">Caricamento deck...</p>
            </div>
        </div>
    </div>

    <!-- Deck Detail View -->
    <div id="deckDetailView" style="display: none;">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <button class="btn btn-outline" onclick="showDecksView()">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div style="flex: 1;">
                <h2 style="margin-bottom: 0.25rem;" id="deckDetailName">Nome Deck</h2>
                <small style="color: var(--text-muted);" id="deckDetailInfo">0 carte</small>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-outline" onclick="showGenerateCardsModal()">
                    <i class="bi bi-magic"></i>
                    Genera con AI
                </button>
                <button class="btn btn-primary" onclick="startStudySession()">
                    <i class="bi bi-play-fill"></i>
                    Studia
                </button>
            </div>
        </div>
        <div id="cardsList" class="deck-grid"></div>
    </div>

    <!-- Study Mode View -->
    <div id="studyView" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <button class="btn btn-outline" onclick="exitStudyMode()">
                <i class="bi bi-x-lg"></i> Esci
            </button>
            <span id="studyProgress" style="font-weight: 600;">1 / 10</span>
            <div style="display: flex; gap: 0.5rem;">
                <span style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-weight: 600;" id="studyCorrect">0</span>
                <span style="background: #ef4444; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-weight: 600;" id="studyIncorrect">0</span>
            </div>
        </div>
        <div class="flashcard-wrapper" onclick="flipCard()">
            <div class="flashcard" id="flashcardElement">
                <div class="flashcard-face flashcard-front">
                    <span class="flashcard-label">Domanda</span>
                    <div class="flashcard-content" id="cardFront">Domanda</div>
                    <span class="flashcard-hint">Clicca per girare</span>
                </div>
                <div class="flashcard-face flashcard-back">
                    <span class="flashcard-label">Risposta</span>
                    <div class="flashcard-content" id="cardBack">Risposta</div>
                </div>
            </div>
        </div>
        <div class="flashcard-controls" style="margin-top: 2rem;">
            <button class="btn btn-danger btn-lg" onclick="answerCard(false)">
                <i class="bi bi-x-lg"></i> Non la sapevo
            </button>
            <button class="btn btn-success btn-lg" onclick="answerCard(true)">
                <i class="bi bi-check-lg"></i> La sapevo
            </button>
        </div>
    </div>
</main>

<!-- Create Deck Modal -->
<div class="modal-overlay" id="createDeckModal">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Crea Nuovo Deck</h5>
            <button class="modal-close" onclick="hideCreateDeckModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Nome Deck *</label>
                <input type="text" class="form-control" id="deckName" placeholder="es. Matematica - Derivate">
            </div>
            <div class="form-group">
                <label class="form-label">Descrizione</label>
                <textarea class="form-control" id="deckDescription" rows="2" placeholder="Descrizione opzionale..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Materia</label>
                <input type="text" class="form-control" id="deckSubject" placeholder="es. Matematica">
            </div>
            <div class="form-group">
                <label class="form-label">Colore</label>
                <div style="display: flex; gap: 0.5rem;" id="colorPicker">
                    <div class="color-option selected" style="background: #3B82F6;" data-color="#3B82F6"></div>
                    <div class="color-option" style="background: #10B981;" data-color="#10B981"></div>
                    <div class="color-option" style="background: #F59E0B;" data-color="#F59E0B"></div>
                    <div class="color-option" style="background: #EF4444;" data-color="#EF4444"></div>
                    <div class="color-option" style="background: #8B5CF6;" data-color="#8B5CF6"></div>
                    <div class="color-option" style="background: #EC4899;" data-color="#EC4899"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideCreateDeckModal()">Annulla</button>
            <button class="btn btn-primary" onclick="createDeck()"><i class="bi bi-plus-lg"></i> Crea Deck</button>
        </div>
    </div>
</div>

<!-- Generate Cards Modal -->
<div class="modal-overlay" id="generateCardsModal">
    <div class="modal">
        <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-magic"></i> Genera Flashcards con AI</h5>
            <button class="modal-close" onclick="hideGenerateCardsModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Argomento *</label>
                <input type="text" class="form-control" id="generateTopic" placeholder="es. Le derivate in matematica">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label class="form-label">Numero carte</label>
                    <select class="form-control form-select" id="generateCount">
                        <option value="5" selected>5 carte</option>
                        <option value="10">10 carte</option>
                        <option value="15">15 carte</option>
                        <option value="20">20 carte</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Difficoltà</label>
                    <select class="form-control form-select" id="generateDifficulty">
                        <option value="PRINCIPIANTE">Facile</option>
                        <option value="INTERMEDIO" selected>Media</option>
                        <option value="AVANZATO">Difficile</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideGenerateCardsModal()">Annulla</button>
            <button class="btn btn-primary" id="generateBtn" onclick="generateCards()">
                <span id="generateBtnText"><i class="bi bi-magic"></i> Genera</span>
                <span id="generateBtnSpinner" style="display: none;">
                    <span class="loading-spinner" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle;"></span> Generazione...
                </span>
            </button>
        </div>
    </div>
</div>

<script src="js/app.js"></script>
<script src="js/layout.js"></script>
<script src="js/focus-manager.js"></script>
<script>
    let decks = [], currentDeck = null, currentCards = [], studyCards = [];
    let studyIndex = 0, studyCorrect = 0, studyIncorrect = 0, selectedColor = '#3B82F6';
    let pendingTopic = null; // Topic dalla pagina spiegazioni

    document.addEventListener('DOMContentLoaded', function() {
        initLayout({ pageTitle: 'Flashcards', pageSubtitle: 'Crea e studia deck di flashcards con l\'aiuto dell\'AI', activePage: 'flashcards' });

        document.querySelectorAll('.color-option').forEach(el => {
            el.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.dataset.color;
            });
        });

        // ========== NUOVO: Controlla se c'è un topic dalla pagina spiegazioni ==========
        const savedTopic = sessionStorage.getItem('flashcardTopic');
        if (savedTopic) {
            pendingTopic = savedTopic;
            sessionStorage.removeItem('flashcardTopic');
        }

        // Controlla se c'è un deckId nella URL (da pagina spiegazioni)
        const urlParams = new URLSearchParams(window.location.search);
        const deckIdFromUrl = urlParams.get('deckId');
        if (deckIdFromUrl) {
            window.deckIdToOpen = deckIdFromUrl;
            // Rimuovi il parametro dalla URL senza ricaricare
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        loadDecks();
        loadStats();
    });

    // ========== NUOVO: Mostra alert per topic dalla spiegazione ==========
    function showTopicFromExplanationAlert(topic) {
        const alert = document.getElementById('topicFromExplanationAlert');
        document.getElementById('topicAlertText').textContent = `Argomento: "${topic}"`;
        document.getElementById('createFromTopicBtn').onclick = () => createDeckFromTopic(topic);
        alert.style.display = 'flex';
    }

    function dismissTopicAlert() {
        document.getElementById('topicFromExplanationAlert').style.display = 'none';
        pendingTopic = null;
    }

    async function createDeckFromTopic(topic) {
        // Pre-compila il modal di creazione deck
        document.getElementById('deckName').value = topic;
        document.getElementById('deckSubject').value = '';
        document.getElementById('deckDescription').value = `Flashcards generate dalla spiegazione su "${topic}"`;
        document.getElementById('createDeckModal').classList.add('active');

        // Nascondi l'alert
        document.getElementById('topicFromExplanationAlert').style.display = 'none';
    }

    function showCreateDeckModal() {
        document.getElementById('deckName').value = '';
        document.getElementById('deckDescription').value = '';
        document.getElementById('deckSubject').value = '';
        document.getElementById('createDeckModal').classList.add('active');
    }
    function hideCreateDeckModal() { document.getElementById('createDeckModal').classList.remove('active'); }

    function showGenerateCardsModal() {
        // Se c'è un topic pendente, pre-compilalo
        if (pendingTopic) {
            document.getElementById('generateTopic').value = pendingTopic;
            pendingTopic = null; // Usa solo una volta
        } else {
            document.getElementById('generateTopic').value = '';
        }
        document.getElementById('generateCardsModal').classList.add('active');
    }
    function hideGenerateCardsModal() { document.getElementById('generateCardsModal').classList.remove('active'); }

    async function loadDecks() {
        try {
            const response = await apiFetch('/flashcards/decks');
            if (response.ok) {
                decks = await response.json();
                renderDecks();

                // ========== NUOVO: Se c'è un deckId dalla URL, aprilo direttamente ==========
                if (window.deckIdToOpen) {
                    const deckToOpen = decks.find(d => d.id === window.deckIdToOpen);
                    if (deckToOpen) {
                        openDeck(window.deckIdToOpen);
                    }
                    window.deckIdToOpen = null;
                    return;
                }

                // ========== NUOVO: Gestione topic dalla spiegazione ==========
                if (pendingTopic) {
                    if (decks.length > 0) {
                        // Se ci sono deck, mostra l'alert per scegliere
                        showTopicFromExplanationAlert(pendingTopic);
                    } else {
                        // Se non ci sono deck, apri direttamente il modal per crearne uno
                        createDeckFromTopic(pendingTopic);
                    }
                }
            }
        } catch (e) {
            document.getElementById('decksGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="bi bi-exclamation-circle empty-state-icon"></i><p>Errore caricamento</p></div>';
        }
    }

    async function loadStats() {
        try {
            const response = await apiFetch('/flashcards/decks/stats');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('statTotalDecks').textContent = stats.totalDecks || 0;
                document.getElementById('statTotalCards').textContent = stats.totalCards || 0;
                document.getElementById('statMastered').textContent = stats.totalMastered || 0;
                document.getElementById('statStudySessions').textContent = stats.totalStudySessions || 0;
            }
        } catch (e) {}
    }

    function renderDecks() {
        const grid = document.getElementById('decksGrid');
        if (decks.length === 0) {
            grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="bi bi-stack empty-state-icon"></i><h4 class="empty-state-title">Nessun deck</h4><p class="empty-state-text">Crea il tuo primo deck!</p><button class="btn btn-primary" onclick="showCreateDeckModal()"><i class="bi bi-plus-lg"></i> Crea Deck</button></div>';
            return;
        }
        grid.innerHTML = decks.map(deck => {
            const progress = deck.totalCards > 0 ? Math.round((deck.cardsMastered / deck.totalCards) * 100) : 0;
            return `<div class="deck-card" onclick="openDeck('${deck.id}')">
                <div class="deck-color-bar" style="background:${deck.color||'#3B82F6'}"></div>
                <div class="deck-header"><div class="deck-icon" style="background:${deck.color||'#3B82F6'}20;color:${deck.color||'#3B82F6'}"><i class="bi bi-stack"></i></div>
                <div class="deck-info"><div class="deck-name">${deck.name}</div><div class="deck-subject">${deck.subject||'Nessuna materia'}</div></div></div>
                <div class="deck-body"><div class="deck-stats"><span><i class="bi bi-card-text"></i> ${deck.totalCards||0} carte</span><span><i class="bi bi-check-circle"></i> ${progress}%</span></div>
                <div class="progress" style="margin-top:0.75rem;"><div class="progress-bar" style="width:${progress}%;background:${deck.color||'#3B82F6'}"></div></div></div></div>`;
        }).join('');
    }

    async function createDeck() {
        const name = document.getElementById('deckName').value.trim();
        if (!name) { showAlert('Inserisci un nome', 'error'); return; }
        try {
            const response = await apiFetch('/flashcards/decks', { method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description: document.getElementById('deckDescription').value.trim() || null, subject: document.getElementById('deckSubject').value.trim() || null, color: selectedColor, isPublic: false })
            });
            if (response.ok) {
                const newDeck = await response.json();
                decks.unshift(newDeck);
                renderDecks();
                loadStats();
                hideCreateDeckModal();
                showAlert('Deck creato!', 'success');

                // ========== NUOVO: Se c'era un topic, apri il deck e mostra il modal di generazione ==========
                if (pendingTopic) {
                    setTimeout(() => {
                        openDeck(newDeck.id);
                        setTimeout(() => {
                            document.getElementById('generateTopic').value = pendingTopic;
                            pendingTopic = null;
                            document.getElementById('generateCardsModal').classList.add('active');
                        }, 300);
                    }, 300);
                }
            }
        } catch (e) { showAlert('Errore creazione deck', 'error'); }
    }

    async function openDeck(deckId) {
        currentDeck = decks.find(d => d.id === deckId);
        if (!currentDeck) return;
        document.getElementById('deckDetailName').textContent = currentDeck.name;
        try {
            const response = await apiFetch(`/flashcards/decks/${deckId}/cards`);
            if (response.ok) { currentCards = await response.json(); document.getElementById('deckDetailInfo').textContent = `${currentCards.length} carte`; renderCards(); }
        } catch (e) {}
        document.getElementById('decksView').style.display = 'none';
        document.getElementById('deckDetailView').style.display = 'block';

        // Nascondi l'alert se presente
        document.getElementById('topicFromExplanationAlert').style.display = 'none';
    }

    function renderCards() {
        const container = document.getElementById('cardsList');
        if (currentCards.length === 0) {
            container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><i class="bi bi-card-text empty-state-icon"></i><h4 class="empty-state-title">Nessuna flashcard</h4><button class="btn btn-primary" onclick="showGenerateCardsModal()"><i class="bi bi-magic"></i> Genera con AI</button></div>';
            return;
        }
        container.innerHTML = currentCards.map((card, i) => {
            const rate = card.timesReviewed > 0 ? Math.round((card.timesCorrect / card.timesReviewed) * 100) : 0;
            const badgeColor = card.timesReviewed > 0 ? (rate >= 80 ? '#10b981' : rate >= 50 ? '#f59e0b' : '#ef4444') : '#6b7280';
            return `<div class="card" style="padding:1rem;"><div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;"><small style="color:var(--text-muted);">#${i+1}</small><span style="background:${badgeColor};color:white;padding:0.125rem 0.5rem;border-radius:0.25rem;font-size:0.75rem;">${card.timesReviewed > 0 ? rate+'%' : 'Nuova'}</span></div><h6 style="margin-bottom:0.5rem;color:#fff;">${truncate(card.frontContent,60)}</h6><p style="color:var(--text-muted);font-size:0.875rem;margin:0;">${truncate(card.backContent,80)}</p></div>`;
        }).join('');
    }

    function showDecksView() {
        document.getElementById('deckDetailView').style.display = 'none';
        document.getElementById('decksView').style.display = 'block';
        currentDeck = null; currentCards = [];
    }

    async function generateCards() {
        const topic = document.getElementById('generateTopic').value.trim();
        if (!topic) { showAlert('Inserisci un argomento', 'error'); return; }
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        document.getElementById('generateBtnText').style.display = 'none';
        document.getElementById('generateBtnSpinner').style.display = 'inline-flex';
        try {
            const response = await apiFetch(`/ai/flashcards/generate?deckId=${currentDeck.id}&topic=${encodeURIComponent(topic)}&numberOfCards=${document.getElementById('generateCount').value}&difficulty=${document.getElementById('generateDifficulty').value}`, { method: 'POST' });
            if (response.ok) { hideGenerateCardsModal(); showAlert('Flashcards generate!', 'success'); await openDeck(currentDeck.id); loadStats(); }
        } catch (e) { showAlert('Errore generazione', 'error'); }
        finally { btn.disabled = false; document.getElementById('generateBtnText').style.display = 'inline-flex'; document.getElementById('generateBtnSpinner').style.display = 'none'; }
    }

    async function startStudySession() {
        if (currentCards.length === 0) { showAlert('Nessuna carta', 'error'); return; }
        try { await apiFetch(`/flashcards/decks/${currentDeck.id}/study`, { method: 'POST' }); } catch (e) {}
        studyCards = [...currentCards].sort(() => Math.random() - 0.5);
        studyIndex = 0; studyCorrect = 0; studyIncorrect = 0;
        document.getElementById('deckDetailView').style.display = 'none';
        document.getElementById('studyView').style.display = 'block';
        showCurrentCard();
    }

    function showCurrentCard() {
        if (studyIndex >= studyCards.length) { endStudySession(); return; }
        const card = studyCards[studyIndex];
        document.getElementById('cardFront').textContent = card.frontContent;
        document.getElementById('cardBack').textContent = card.backContent;
        document.getElementById('studyProgress').textContent = `${studyIndex + 1} / ${studyCards.length}`;
        document.getElementById('studyCorrect').textContent = studyCorrect;
        document.getElementById('studyIncorrect').textContent = studyIncorrect;
        document.getElementById('flashcardElement').classList.remove('flipped');
    }

    function flipCard() { document.getElementById('flashcardElement').classList.toggle('flipped'); }

    async function answerCard(wasCorrect) {
        try { await apiFetch(`/flashcards/cards/${studyCards[studyIndex].id}/review`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ wasCorrect }) }); } catch (e) {}
        wasCorrect ? studyCorrect++ : studyIncorrect++;
        studyIndex++;
        showCurrentCard();
    }

    function endStudySession() {
        const pct = Math.round((studyCorrect / studyCards.length) * 100);
        document.getElementById('studyView').innerHTML = `<div class="card quiz-result"><div class="card-icon ${pct>=70?'success':'warning'}" style="width:80px;height:80px;border-radius:50%;margin:0 auto 1.5rem;font-size:2rem;"><i class="bi ${pct>=70?'bi-trophy':'bi-emoji-smile'}"></i></div><h2 style="text-align:center;">${pct>=70?'Ottimo lavoro!':'Continua così!'}</h2><p style="text-align:center;color:var(--text-muted);margin-bottom:2rem;">Sessione completata</p><div style="display:flex;justify-content:center;gap:2rem;margin-bottom:2rem;flex-wrap:wrap;"><div class="stat-card" style="min-width:100px;text-align:center;"><div class="stat-value" style="color:#10b981;">${studyCorrect}</div><div class="stat-label">Corrette</div></div><div class="stat-card" style="min-width:100px;text-align:center;"><div class="stat-value" style="color:#ef4444;">${studyIncorrect}</div><div class="stat-label">Da ripassare</div></div><div class="stat-card" style="min-width:100px;text-align:center;"><div class="stat-value">${pct}%</div><div class="stat-label">Punteggio</div></div></div><div style="display:flex;gap:1rem;justify-content:center;"><button class="btn btn-outline" onclick="location.reload()"><i class="bi bi-arrow-left"></i> Torna</button><button class="btn btn-primary" onclick="location.reload()"><i class="bi bi-arrow-repeat"></i> Studia ancora</button></div></div>`;
        loadStats();
    }

    function exitStudyMode() { location.reload(); }
    function truncate(str, len) { return str && str.length > len ? str.substring(0, len) + '...' : str || ''; }
</script>
</body>
</html>