<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz AI - AI Study Buddy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        /* ==================== HERO SECTION ==================== */
        .quiz-hero {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #7c3aed 100%);
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(59, 130, 246, 0.4);
        }

        .quiz-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .quiz-hero::after {
            content: '?';
            position: absolute;
            right: 40px;
            bottom: -20px;
            font-size: 180px;
            font-weight: 800;
            color: rgba(255,255,255,0.08);
            pointer-events: none;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .hero-badge i { font-size: 1rem; }

        .hero-title {
            font-size: 2rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .hero-subtitle {
            color: rgba(255,255,255,0.85);
            font-size: 1rem;
            margin-bottom: 0;
        }

        /* ==================== SETUP CARD ==================== */
        .setup-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 1.25rem;
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .setup-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #7c3aed);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #ffffff;
        }

        .setup-title { font-size: 1.25rem; font-weight: 700; color: #ffffff; }
        .setup-subtitle { font-size: 0.875rem; color: var(--text-muted); }

        .setup-body { padding: 2rem; }

        .input-group { margin-bottom: 1.5rem; }
        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .topic-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--dark-bg);
            border: 2px solid var(--dark-border);
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .topic-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }

        .topic-input::placeholder { color: var(--text-muted); }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .option-select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--dark-bg);
            border: 2px solid var(--dark-border);
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .generate-btn {
            width: 100%;
            padding: 1.125rem;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn i { font-size: 1.25rem; }

        /* Quick Topics */
        .quick-topics {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .quick-topic {
            padding: 0.5rem 1rem;
            background: var(--dark-border);
            border: none;
            border-radius: 2rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-topic:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* ==================== HISTORY SECTION ==================== */
        .history-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--dark-border);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .history-title {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-title i { color: var(--text-muted); }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .history-card {
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .history-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #7c3aed);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .history-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .history-card:hover::before { opacity: 1; }

        .history-card-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-card-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .history-card-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

        /* ==================== QUIZ IN PROGRESS ==================== */
        .quiz-progress-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 1.25rem;
            overflow: hidden;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .quiz-progress-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .quiz-progress-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .quiz-progress-info h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .quiz-progress-info span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .quiz-exit-btn {
            padding: 0.5rem 1rem;
            background: var(--dark-border);
            border: none;
            border-radius: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .quiz-exit-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .progress-bar-container {
            background: var(--dark-bg);
            border-radius: 1rem;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #7c3aed);
            border-radius: 1rem;
            transition: width 0.5s ease;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .progress-stats span { color: var(--text-muted); }
        .progress-stats .answered { color: #60a5fa; font-weight: 600; }

        /* ==================== QUESTION CARD ==================== */
        .question-container { padding: 2rem; }

        .question-number {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.15);
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 1.25rem;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .options-list { display: flex; flex-direction: column; gap: 0.75rem; }

        .option-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: var(--dark-bg);
            border: 2px solid var(--dark-border);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .option-item.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        .option-item.correct {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        .option-item.incorrect {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
        }

        .option-letter {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            background: var(--dark-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .option-item.selected .option-letter {
            background: #3b82f6;
            color: #ffffff;
        }

        .option-item.correct .option-letter {
            background: #10b981;
            color: #ffffff;
        }

        .option-item.incorrect .option-letter {
            background: #ef4444;
            color: #ffffff;
        }

        .option-text {
            flex: 1;
            color: var(--text-secondary);
            font-size: 1rem;
            transition: color 0.3s ease;
        }

        .option-item.selected .option-text,
        .option-item:hover .option-text { color: #ffffff; }

        .option-icon {
            font-size: 1.25rem;
            margin-left: auto;
        }

        .option-item.correct .option-icon { color: #10b981; }
        .option-item.incorrect .option-icon { color: #ef4444; }

        /* Navigation */
        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--dark-border);
            background: rgba(0,0,0,0.2);
        }

        .nav-btn {
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-btn.secondary {
            background: var(--dark-border);
            border: none;
            color: var(--text-secondary);
        }

        .nav-btn.secondary:hover:not(:disabled) {
            background: rgba(107, 114, 128, 0.4);
            color: #ffffff;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            color: #ffffff;
        }

        .nav-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Review Badge */
        .review-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 2rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .review-badge.correct { background: #10b981; color: #ffffff; }
        .review-badge.incorrect { background: #ef4444; color: #ffffff; }

        /* ==================== RESULTS ==================== */
        .results-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 1.5rem;
            overflow: hidden;
            animation: slideUp 0.5s ease;
        }

        .results-header {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            padding: 3rem 2rem;
            text-align: center;
        }

        .results-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1.5rem;
            animation: popIn 0.6s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .results-icon.excellent { background: rgba(16, 185, 129, 0.2); }
        .results-icon.good { background: rgba(59, 130, 246, 0.2); }
        .results-icon.average { background: rgba(245, 158, 11, 0.2); }
        .results-icon.poor { background: rgba(239, 68, 68, 0.2); }

        .results-score {
            font-size: 4rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .results-label {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .results-body { padding: 2rem; }

        .results-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .result-stat {
            text-align: center;
            padding: 1.25rem 2rem;
            background: var(--dark-bg);
            border-radius: 1rem;
            min-width: 120px;
        }

        .result-stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .result-stat-value.correct { color: #10b981; }
        .result-stat-value.incorrect { color: #ef4444; }

        .result-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .results-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .result-btn {
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .result-btn.secondary {
            background: var(--dark-border);
            border: none;
            color: var(--text-secondary);
        }

        .result-btn.secondary:hover {
            background: rgba(107, 114, 128, 0.4);
            color: #ffffff;
        }

        .result-btn.primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border: none;
            color: #ffffff;
        }

        .result-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        /* ==================== LOADING ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active { opacity: 1; visibility: visible; }

        .loading-content {
            text-align: center;
            color: #ffffff;
        }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 4px solid var(--dark-border);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .loading-subtext { color: var(--text-muted); }

        /* Responsive */
        @media (max-width: 768px) {
            .quiz-hero { padding: 2rem 1.5rem; }
            .hero-title { font-size: 1.5rem; }
            .setup-body, .question-container { padding: 1.5rem; }
            .options-grid { grid-template-columns: 1fr; }
            .results-stats { flex-direction: column; gap: 1rem; }
            .results-actions { flex-direction: column; }
            .result-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
<main class="main-content">
    <div id="alertContainer"></div>

    <!-- Hero Section -->
    <div class="quiz-hero" id="quizHero">
        <div class="hero-content">
            <div class="hero-badge">
                <i class="bi bi-lightning-charge-fill"></i>
                Quiz con AI
            </div>
            <h1 class="hero-title">Metti alla prova le tue conoscenze</h1>
            <p class="hero-subtitle">Genera quiz personalizzati su qualsiasi argomento e scopri quanto ne sai</p>
        </div>
    </div>

    <!-- Quiz Setup -->
    <div id="quizSetup" class="setup-card">
        <div class="setup-header">
            <div class="setup-icon"><i class="bi bi-patch-question-fill"></i></div>
            <div>
                <div class="setup-title">Configura il Quiz</div>
                <div class="setup-subtitle">Scegli argomento, difficolt√† e numero di domande</div>
            </div>
        </div>
        <div class="setup-body">
            <div class="input-group">
                <label>Argomento del Quiz</label>
                <input type="text" class="topic-input" id="quizTopic" placeholder="Es: Seconda Guerra Mondiale, Derivate, Python...">
                <div class="quick-topics">
                    <button class="quick-topic" onclick="setTopic('Seconda Guerra Mondiale')">üè∞ Storia</button>
                    <button class="quick-topic" onclick="setTopic('Derivate e integrali')">üìê Matematica</button>
                    <button class="quick-topic" onclick="setTopic('Programmazione Java')">üíª Coding</button>
                    <button class="quick-topic" onclick="setTopic('Anatomia umana')">üß¨ Biologia</button>
                    <button class="quick-topic" onclick="setTopic('Leggi della fisica')">‚öõÔ∏è Fisica</button>
                </div>
            </div>

            <div class="options-grid">
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Numero Domande</label>
                    <select class="option-select" id="numQuestions">
                        <option value="5">5 domande</option>
                        <option value="10" selected>10 domande</option>
                        <option value="15">15 domande</option>
                        <option value="20">20 domande</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Difficolt√†</label>
                    <select class="option-select" id="quizDifficulty">
                        <option value="PRINCIPIANTE">üü¢ Facile</option>
                        <option value="INTERMEDIO" selected>üü° Media</option>
                        <option value="AVANZATO">üî¥ Difficile</option>
                    </select>
                </div>
            </div>

            <button class="generate-btn" id="generateBtn" onclick="generateQuiz()">
                <i class="bi bi-magic"></i>
                <span id="generateBtnText">Genera Quiz</span>
            </button>

            <!-- History Section -->
            <div class="history-section" id="quizHistorySection" style="display: none;">
                <div class="history-header">
                    <div class="history-title"><i class="bi bi-clock-history"></i> Quiz Recenti</div>
                </div>
                <div class="history-grid" id="quizHistoryList"></div>
            </div>
        </div>
    </div>

    <!-- Quiz In Progress -->
    <div id="quizQuestionsContainer" style="display: none;">
        <div class="quiz-progress-card">
            <div class="quiz-progress-header">
                <div class="quiz-progress-top">
                    <div class="quiz-progress-info">
                        <h3 id="quizTitle">Quiz</h3>
                        <span id="quizInfo"></span>
                    </div>
                    <button class="quiz-exit-btn" onclick="resetQuiz()">
                        <i class="bi bi-x-lg"></i> Esci
                    </button>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <div class="progress-stats">
                    <span id="progressText">Domanda 1 di 10</span>
                    <span class="answered" id="scoreText">0 risposte</span>
                </div>
            </div>

            <div class="question-container" id="questionContainer"></div>

            <div class="quiz-navigation">
                <button class="nav-btn secondary" id="prevBtn" onclick="prevQuestion()" disabled>
                    <i class="bi bi-arrow-left"></i> Precedente
                </button>
                <button class="nav-btn primary" id="nextBtn" onclick="nextQuestion()">
                    Successiva <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Results -->
    <div id="quizResults" style="display: none;">
        <div class="results-card">
            <div class="results-header">
                <div class="results-icon" id="resultIcon">üèÜ</div>
                <div class="results-score" id="finalScore">85%</div>
                <div class="results-label" id="finalLabel">Ottimo lavoro!</div>
            </div>
            <div class="results-body">
                <div class="results-stats">
                    <div class="result-stat">
                        <div class="result-stat-value correct" id="correctCount">8</div>
                        <div class="result-stat-label">Corrette</div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-value incorrect" id="incorrectCount">2</div>
                        <div class="result-stat-label">Sbagliate</div>
                    </div>
                </div>
                <div class="results-actions">
                    <button class="result-btn secondary" onclick="reviewAnswers()">
                        <i class="bi bi-eye"></i> Rivedi Risposte
                    </button>
                    <button class="result-btn primary" onclick="resetQuiz()">
                        <i class="bi bi-arrow-repeat"></i> Nuovo Quiz
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner-large"></div>
        <div class="loading-text">Generazione Quiz...</div>
        <div class="loading-subtext" id="loadingSubtext">L'AI sta creando le tue domande</div>
    </div>
</div>

<script src="js/app.js"></script>
<script src="js/layout.js"></script>
<script src="js/focus-manager.js"></script>
<script>
    let currentQuiz = null;
    let quizQuestions = [];
    let currentQuestion = 0;
    let userAnswers = {};
    let score = 0;

    document.addEventListener('DOMContentLoaded', function() {
        initLayout({
            pageTitle: 'Quiz AI',
            pageSubtitle: 'Genera quiz personalizzati con l\'intelligenza artificiale',
            activePage: 'quiz'
        });

        loadQuizHistory();

        const savedTopic = sessionStorage.getItem('quizTopic');
        if (savedTopic) {
            document.getElementById('quizTopic').value = savedTopic;
            sessionStorage.removeItem('quizTopic');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const quizIdFromUrl = urlParams.get('quizId');
        if (quizIdFromUrl) {
            window.history.replaceState({}, document.title, window.location.pathname);
            loadQuiz(quizIdFromUrl);
        }
    });

    function setTopic(topic) {
        document.getElementById('quizTopic').value = topic;
        document.getElementById('quizTopic').focus();
    }

    async function generateQuiz() {
        const topic = document.getElementById('quizTopic').value.trim();
        const numQuestions = document.getElementById('numQuestions').value;
        const difficulty = document.getElementById('quizDifficulty').value;

        if (!topic) {
            showAlert('Inserisci un argomento per il quiz', 'error');
            return;
        }

        showLoading(`Creazione di ${numQuestions} domande su "${topic}"...`);

        try {
            const response = await apiFetch(
                `/ai/quiz/generate?topic=${encodeURIComponent(topic)}&numberOfQuestions=${numQuestions}&difficulty=${difficulty}`,
                { method: 'POST' }
            );

            if (response.ok) {
                const quiz = await response.json();
                currentQuiz = quiz;
                quizQuestions = quiz.questions || [];

                if (quizQuestions.length === 0) {
                    throw new Error('Nessuna domanda generata');
                }

                currentQuestion = 0;
                userAnswers = {};
                score = 0;

                await startQuiz(quiz.id);

                document.getElementById('quizTitle').textContent = quiz.title || `Quiz: ${topic}`;
                document.getElementById('quizInfo').textContent = `${quizQuestions.length} domande ‚Ä¢ ${getDifficultyLabel(difficulty)}`;

                document.getElementById('quizSetup').style.display = 'none';
                document.getElementById('quizHero').style.display = 'none';
                document.getElementById('quizQuestionsContainer').style.display = 'block';

                renderQuestion();
            } else {
                const error = await response.text();
                showAlert('Errore: ' + error, 'error');
            }
        } catch (error) {
            console.error('Errore:', error);
            showAlert('Errore nella generazione del quiz. Riprova.', 'error');
        } finally {
            hideLoading();
        }
    }

    function showLoading(text) {
        document.getElementById('loadingSubtext').textContent = text || 'L\'AI sta creando le tue domande';
        document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    async function startQuiz(quizId) {
        try {
            await apiFetch(`/ai/quiz/${quizId}/start`, { method: 'POST' });
        } catch (error) {
            console.warn('Errore start quiz:', error);
        }
    }

    function getDifficultyLabel(difficulty) {
        const labels = { 'PRINCIPIANTE': 'Facile', 'INTERMEDIO': 'Media', 'AVANZATO': 'Difficile' };
        return labels[difficulty] || difficulty;
    }

    function renderQuestion() {
        const q = quizQuestions[currentQuestion];
        const container = document.getElementById('questionContainer');
        const letters = ['A', 'B', 'C', 'D'];
        const options = [q.optionA, q.optionB, q.optionC, q.optionD];

        let optionsHtml = options.map((option, index) => {
            const letter = letters[index];
            const isSelected = userAnswers[q.id] === letter;
            return `
                <div class="option-item ${isSelected ? 'selected' : ''}" onclick="selectOption('${q.id}', '${letter}')">
                    <div class="option-letter">${letter}</div>
                    <div class="option-text">${option}</div>
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div class="question-number">
                <i class="bi bi-question-circle"></i>
                Domanda ${currentQuestion + 1} di ${quizQuestions.length}
            </div>
            <div class="question-text">${q.questionText}</div>
            <div class="options-list">${optionsHtml}</div>
        `;

        updateProgress();
        updateNavigation();
    }

    function selectOption(questionId, letter) {
        userAnswers[questionId] = letter;
        renderQuestion();
    }

    function updateProgress() {
        const progress = ((currentQuestion + 1) / quizQuestions.length) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        document.getElementById('progressText').textContent = `Domanda ${currentQuestion + 1} di ${quizQuestions.length}`;
        const answered = Object.keys(userAnswers).length;
        document.getElementById('scoreText').textContent = `${answered} risposte`;
    }

    function updateNavigation() {
        document.getElementById('prevBtn').disabled = currentQuestion === 0;
        const nextBtn = document.getElementById('nextBtn');
        if (currentQuestion === quizQuestions.length - 1) {
            nextBtn.innerHTML = '<i class="bi bi-check-lg"></i> Termina Quiz';
            nextBtn.onclick = finishQuiz;
        } else {
            nextBtn.innerHTML = 'Successiva <i class="bi bi-arrow-right"></i>';
            nextBtn.onclick = nextQuestion;
        }
    }

    function prevQuestion() {
        if (currentQuestion > 0) { currentQuestion--; renderQuestion(); }
    }

    function nextQuestion() {
        if (currentQuestion < quizQuestions.length - 1) { currentQuestion++; renderQuestion(); }
    }

    async function finishQuiz() {
        try {
            const answersPayload = { quizId: currentQuiz.id, answers: userAnswers };
            const response = await apiFetch('/ai/quiz/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(answersPayload)
            });

            if (response.ok) {
                const result = await response.json();
                console.log('Quiz result:', result);

                // Calcola score localmente se non presente
                let correctCount = result.score;
                if (correctCount === undefined || correctCount === null) {
                    correctCount = 0;
                    quizQuestions.forEach(q => {
                        if (userAnswers[q.id] === q.correctAnswer) correctCount++;
                    });
                }
                score = correctCount;

                // Calcola percentage localmente se non presente o NaN
                let percentage = result.percentage;
                if (percentage === undefined || percentage === null || isNaN(percentage)) {
                    const total = result.totalQuestions || quizQuestions.length;
                    percentage = total > 0 ? (correctCount / total) * 100 : 0;
                }

                const incorrectCount = (result.totalQuestions || quizQuestions.length) - correctCount;
                showResults(Math.round(percentage), correctCount, incorrectCount);
            } else {
                throw new Error('Errore nel salvataggio');
            }
        } catch (error) {
            console.error('Errore:', error);
            calculateScoreLocally();
        }
    }

    function calculateScoreLocally() {
        score = 0;
        quizQuestions.forEach(q => {
            if (userAnswers[q.id] === q.correctAnswer) score++;
        });
        const total = quizQuestions.length;
        const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
        showResults(percentage, score, total - score);
    }

    function showResults(percentage, correct, incorrect) {
        // Assicurati che i valori siano numeri validi
        percentage = isNaN(percentage) ? 0 : percentage;
        correct = isNaN(correct) ? 0 : correct;
        incorrect = isNaN(incorrect) ? 0 : incorrect;

        document.getElementById('finalScore').textContent = `${percentage}%`;
        document.getElementById('correctCount').textContent = correct;
        document.getElementById('incorrectCount').textContent = incorrect;

        let label, icon, iconClass;
        if (percentage >= 90) { label = 'Eccellente! üéâ'; icon = 'üèÜ'; iconClass = 'excellent'; }
        else if (percentage >= 70) { label = 'Ottimo lavoro! üëè'; icon = 'üéØ'; iconClass = 'good'; }
        else if (percentage >= 50) { label = 'Buon risultato! üí™'; icon = 'üí™'; iconClass = 'average'; }
        else { label = 'Continua a studiare! üìö'; icon = 'üìö'; iconClass = 'poor'; }

        document.getElementById('finalLabel').textContent = label;
        const resultIcon = document.getElementById('resultIcon');
        resultIcon.textContent = icon;
        resultIcon.className = `results-icon ${iconClass}`;

        document.getElementById('quizQuestionsContainer').style.display = 'none';
        document.getElementById('quizResults').style.display = 'block';

        showAlert(`Quiz completato! Punteggio: ${percentage}%`, 'success');
    }

    function reviewAnswers() {
        document.getElementById('quizResults').style.display = 'none';
        document.getElementById('quizQuestionsContainer').style.display = 'block';
        currentQuestion = 0;
        renderQuestionReview();
    }

    function renderQuestionReview() {
        const q = quizQuestions[currentQuestion];
        const container = document.getElementById('questionContainer');
        const letters = ['A', 'B', 'C', 'D'];
        const options = [q.optionA, q.optionB, q.optionC, q.optionD];
        const userAnswer = userAnswers[q.id];
        const isUserCorrect = userAnswer === q.correctAnswer;

        let optionsHtml = options.map((option, index) => {
            const letter = letters[index];
            const isCorrect = letter === q.correctAnswer;
            const isUserAnswer = userAnswer === letter;
            let className = '';
            if (isCorrect) className = 'correct';
            else if (isUserAnswer && !isCorrect) className = 'incorrect';

            return `
                <div class="option-item ${className}" style="cursor: default;">
                    <div class="option-letter">${letter}</div>
                    <div class="option-text">${option}</div>
                    ${isCorrect ? '<i class="bi bi-check-lg option-icon"></i>' : ''}
                    ${isUserAnswer && !isCorrect ? '<i class="bi bi-x-lg option-icon"></i>' : ''}
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
                <div class="question-number">
                    <i class="bi bi-question-circle"></i>
                    Domanda ${currentQuestion + 1} di ${quizQuestions.length}
                </div>
                <span class="review-badge ${isUserCorrect ? 'correct' : 'incorrect'}">
                    ${isUserCorrect ? '‚úì Corretta' : '‚úó Sbagliata'}
                </span>
            </div>
            <div class="question-text">${q.questionText}</div>
            <div class="options-list">${optionsHtml}</div>
        `;

        updateProgress();

        document.getElementById('prevBtn').disabled = currentQuestion === 0;
        const nextBtn = document.getElementById('nextBtn');
        if (currentQuestion === quizQuestions.length - 1) {
            nextBtn.innerHTML = '<i class="bi bi-bar-chart"></i> Torna ai Risultati';
            nextBtn.onclick = () => {
                document.getElementById('quizQuestionsContainer').style.display = 'none';
                document.getElementById('quizResults').style.display = 'block';
            };
        } else {
            nextBtn.innerHTML = 'Successiva <i class="bi bi-arrow-right"></i>';
            nextBtn.onclick = () => { currentQuestion++; renderQuestionReview(); };
        }

        document.getElementById('prevBtn').onclick = () => {
            if (currentQuestion > 0) { currentQuestion--; renderQuestionReview(); }
        };
    }

    async function loadQuizHistory() {
        try {
            const response = await apiFetch('/ai/quiz/my');
            if (response.ok) {
                const quizzes = await response.json();
                if (quizzes.length > 0) renderQuizHistory(quizzes.slice(0, 6));
            }
        } catch (error) {
            console.warn('Errore caricamento storico:', error);
        }
    }

    function renderQuizHistory(quizzes) {
        const section = document.getElementById('quizHistorySection');
        const list = document.getElementById('quizHistoryList');

        list.innerHTML = quizzes.map(quiz => {
            const date = new Date(quiz.createdAt).toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
            const badge = quiz.isCompleted
                ? `<span class="history-card-badge badge-success"><i class="bi bi-check-circle"></i> ${quiz.percentage}%</span>`
                : '<span class="history-card-badge badge-warning"><i class="bi bi-clock"></i> In corso</span>';

            return `
                <div class="history-card" onclick="loadQuiz('${quiz.id}')">
                    <div class="history-card-title">${quiz.title || quiz.topic}</div>
                    <div class="history-card-meta">${quiz.numberOfQuestions} domande ‚Ä¢ ${date}</div>
                    ${badge}
                </div>
            `;
        }).join('');

        section.style.display = 'block';
    }

    async function loadQuiz(quizId) {
        showLoading('Caricamento quiz...');
        try {
            const response = await apiFetch(`/ai/quiz/${quizId}`);
            if (response.ok) {
                const quiz = await response.json();
                currentQuiz = quiz;
                quizQuestions = quiz.questions || [];
                currentQuestion = 0;

                userAnswers = {};
                quizQuestions.forEach(q => { if (q.userAnswer) userAnswers[q.id] = q.userAnswer; });

                document.getElementById('quizTitle').textContent = quiz.title;
                document.getElementById('quizInfo').textContent = `${quizQuestions.length} domande ‚Ä¢ ${getDifficultyLabel(quiz.difficultyLevel)}`;
                document.getElementById('quizSetup').style.display = 'none';
                document.getElementById('quizHero').style.display = 'none';

                if (quiz.isCompleted) {
                    // Calcola score localmente se non presente
                    let correctCount = quiz.score;
                    if (correctCount === undefined || correctCount === null) {
                        correctCount = 0;
                        quizQuestions.forEach(q => {
                            if (userAnswers[q.id] === q.correctAnswer) correctCount++;
                        });
                    }
                    score = correctCount;

                    // Calcola percentage localmente se non presente o NaN
                    let percentage = quiz.percentage;
                    if (percentage === undefined || percentage === null || isNaN(percentage)) {
                        percentage = quizQuestions.length > 0 ? (correctCount / quizQuestions.length) * 100 : 0;
                    }

                    showResults(Math.round(percentage), correctCount, quizQuestions.length - correctCount);
                } else {
                    document.getElementById('quizQuestionsContainer').style.display = 'block';
                    renderQuestion();
                }
            }
        } catch (error) {
            console.error('Errore:', error);
            showAlert('Errore nel caricamento del quiz', 'error');
        } finally {
            hideLoading();
        }
    }

    function resetQuiz() {
        currentQuiz = null;
        quizQuestions = [];
        currentQuestion = 0;
        userAnswers = {};
        score = 0;

        document.getElementById('quizSetup').style.display = 'block';
        document.getElementById('quizHero').style.display = 'block';
        document.getElementById('quizQuestionsContainer').style.display = 'none';
        document.getElementById('quizResults').style.display = 'none';
        document.getElementById('quizTopic').value = '';

        loadQuizHistory();
    }
</script>
</body>
</html>