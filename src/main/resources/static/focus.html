<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modalit√† Focus - AI Study Buddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <style>
    .focus-container {
        min-height: calc(100vh - 100px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    /* ==================== SETUP SCREEN ==================== */
    .setup-screen {
        text-align: center;
        max-width: 500px;
        width: 100%;
    }

    .setup-title {
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0.5rem;
    }

    .setup-subtitle {
        color: var(--text-muted);
        margin-bottom: 2rem;
    }

    /* Duration Selection */
    .duration-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .duration-option {
        background: var(--dark-card);
        border: 2px solid var(--dark-border);
        border-radius: 1rem;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .duration-option:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .duration-option.selected {
        border-color: var(--primary-color);
        background: rgba(139, 92, 246, 0.1);
    }

    .duration-option .time {
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
        display: block;
    }

    .duration-option .label {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .duration-option .xp-info {
        margin-top: 0.5rem;
        color: var(--primary-color);
        font-size: 0.85rem;
        font-weight: 600;
    }

    /* Custom Duration */
    .custom-duration {
        background: var(--dark-card);
        border: 2px solid var(--dark-border);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .custom-duration.active {
        border-color: var(--primary-color);
    }

    .custom-duration-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .custom-duration-label {
        color: #ffffff;
        font-weight: 600;
    }

    .custom-duration-value {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.25rem;
    }

    .duration-slider {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        background: var(--dark-border);
        border-radius: 4px;
        outline: none;
    }

    .duration-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
    }

    .duration-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }

    /* XP Preview */
    .xp-preview {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 1rem;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .xp-preview i {
        font-size: 1.5rem;
        color: var(--primary-color);
    }

    .xp-preview-text {
        color: #ffffff;
    }

    .xp-preview-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Start Button */
    .start-focus-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        padding: 1rem 3rem;
        border-radius: 1rem;
        color: #ffffff;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: all 0.3s ease;
        margin: 0 auto;
    }

    .start-focus-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
    }

    .start-focus-btn i {
        font-size: 1.3rem;
    }

    /* ==================== TIMER SCREEN ==================== */
    .timer-screen {
        display: none;
        text-align: center;
        width: 100%;
        max-width: 400px;
    }

    .timer-screen.active {
        display: block;
    }

    .setup-screen.hidden {
        display: none;
    }

    /* Timer Circle */
    .timer-wrapper {
        position: relative;
        width: 300px;
        height: 300px;
        margin: 0 auto 2rem;
    }

    .timer-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: var(--dark-card);
        border: 4px solid var(--dark-border);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 2;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .timer-circle.active {
        border-color: #10b981;
        box-shadow: 0 0 60px rgba(16, 185, 129, 0.3);
    }

    .timer-circle.paused {
        border-color: #f59e0b;
        box-shadow: 0 0 60px rgba(245, 158, 11, 0.3);
    }

    /* Progress Ring */
    .progress-ring {
        position: absolute;
        top: -4px;
        left: -4px;
        width: calc(100% + 8px);
        height: calc(100% + 8px);
        z-index: 1;
        transform: rotate(-90deg);
    }

    .progress-ring circle {
        fill: none;
        stroke-width: 8;
        stroke-linecap: round;
    }

    .progress-ring .bg {
        stroke: var(--dark-border);
    }

    .progress-ring .progress {
        stroke: #10b981;
        transition: stroke-dashoffset 1s linear;
    }

    /* Timer Display */
    .timer-display {
        font-size: 4rem;
        font-weight: 700;
        color: #ffffff;
        font-variant-numeric: tabular-nums;
        line-height: 1;
    }

    .timer-label {
        font-size: 1rem;
        color: #10b981;
        margin-top: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 600;
    }

    .timer-label.paused {
        color: #f59e0b;
    }

    /* Session Stats */
    .session-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .session-stat {
        text-align: center;
    }

    .session-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #ffffff;
    }

    .session-stat-value.xp {
        color: var(--primary-color);
    }

    .session-stat-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Controls */
    .timer-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
    }

    .control-btn.primary {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
        font-size: 2rem;
    }

    .control-btn.primary:hover {
        transform: scale(1.1);
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }

    .control-btn.primary.paused {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .control-btn.secondary {
        background: var(--dark-card);
        border: 2px solid var(--dark-border);
        color: var(--text-secondary);
    }

    .control-btn.secondary:hover {
        border-color: #10b981;
        color: #ffffff;
    }

    .control-btn.danger:hover {
        border-color: #ef4444;
        color: #ef4444;
    }

    /* XP Milestone Toast */
    .xp-toast {
        position: fixed;
        top: 100px;
        right: 20px;
        background: var(--dark-card);
        border: 2px solid var(--primary-color);
        border-radius: 1rem;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        z-index: 1000;
        animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    .xp-toast i {
        font-size: 1.5rem;
        color: var(--primary-color);
    }

    .xp-toast-text {
        color: #ffffff;
        font-weight: 600;
    }

    .xp-toast-value {
        color: var(--primary-color);
    }

    /* Completion Modal */
    .completion-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .completion-modal.show {
        display: flex;
    }

    .completion-content {
        background: var(--dark-card);
        border: 2px solid #10b981;
        border-radius: 1.5rem;
        padding: 3rem;
        text-align: center;
        max-width: 420px;
        animation: popIn 0.4s ease;
    }

    @keyframes popIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .completion-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .completion-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0.5rem;
    }

    .completion-subtitle {
        color: var(--text-muted);
        margin-bottom: 2rem;
    }

    .completion-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .completion-stat {
        text-align: center;
    }

    .completion-stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .completion-stat-label {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .completion-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    /* Info Box */
    .xp-info-box {
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-top: 1.5rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .xp-info-box strong {
        color: var(--primary-color);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .timer-wrapper {
            width: 260px;
            height: 260px;
        }

        .timer-display {
            font-size: 3rem;
        }

        .duration-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .duration-option {
            padding: 1rem;
        }

        .duration-option .time {
            font-size: 1.5rem;
        }
    }
  </style>
</head>
<body>
<main class="main-content">
  <div class="focus-container">

    <!-- ==================== SETUP SCREEN ==================== -->
    <div class="setup-screen" id="setupScreen">
      <h1 class="setup-title">üéØ Modalit√† Focus</h1>
      <p class="setup-subtitle">Scegli quanto tempo vuoi concentrarti</p>

      <!-- Duration Options -->
      <div class="duration-grid">
        <div class="duration-option" data-minutes="15" onclick="selectDuration(15)">
          <span class="time">15</span>
          <span class="label">minuti</span>
          <span class="xp-info">+4 XP</span>
        </div>
        <div class="duration-option selected" data-minutes="25" onclick="selectDuration(25)">
          <span class="time">25</span>
          <span class="label">minuti</span>
          <span class="xp-info">+7 XP</span>
        </div>
        <div class="duration-option" data-minutes="45" onclick="selectDuration(45)">
          <span class="time">45</span>
          <span class="label">minuti</span>
          <span class="xp-info">+13 XP</span>
        </div>
        <div class="duration-option" data-minutes="60" onclick="selectDuration(60)">
          <span class="time">60</span>
          <span class="label">minuti</span>
          <span class="xp-info">+18 XP</span>
        </div>
      </div>

      <!-- Custom Duration -->
      <div class="custom-duration" id="customDuration">
        <div class="custom-duration-header">
          <span class="custom-duration-label">‚è±Ô∏è Durata personalizzata</span>
          <span class="custom-duration-value"><span id="customMinutes">25</span> min</span>
        </div>
        <input type="range" class="duration-slider" id="durationSlider"
               min="5" max="120" value="25" step="5"
               oninput="updateCustomDuration(this.value)">
      </div>

      <!-- XP Preview -->
      <div class="xp-preview">
        <i class="bi bi-lightning-charge-fill"></i>
        <div class="xp-preview-text">
          Guadagnerai circa <span class="xp-preview-value" id="xpPreview">7</span> XP
        </div>
      </div>

      <!-- Start Button -->
      <button class="start-focus-btn" onclick="startFocusSession()">
        <i class="bi bi-play-fill"></i>
        Inizia Focus
      </button>

      <!-- XP Info -->
      <div class="xp-info-box">
        <i class="bi bi-info-circle"></i>
        <strong>Come funziona:</strong> Guadagni <strong>+3 XP ogni 10 minuti</strong> di focus completati,
        pi√π <strong>+1 XP bonus</strong> se completi l'intera sessione!
      </div>
    </div>

    <!-- ==================== TIMER SCREEN ==================== -->
    <div class="timer-screen" id="timerScreen">

      <!-- Session Stats -->
      <div class="session-stats">
        <div class="session-stat">
          <div class="session-stat-value" id="elapsedTime">0:00</div>
          <div class="session-stat-label">Tempo trascorso</div>
        </div>
        <div class="session-stat">
          <div class="session-stat-value xp" id="earnedXp">0</div>
          <div class="session-stat-label">XP guadagnati</div>
        </div>
      </div>

      <!-- Timer -->
      <div class="timer-wrapper">
        <svg class="progress-ring" viewBox="0 0 308 308">
          <circle class="bg" cx="154" cy="154" r="150"/>
          <circle class="progress" id="progressCircle" cx="154" cy="154" r="150"
                  stroke-dasharray="942.48" stroke-dashoffset="0"/>
        </svg>
        <div class="timer-circle" id="timerCircle">
          <div class="timer-display" id="timerDisplay">25:00</div>
          <div class="timer-label" id="timerLabel">FOCUS</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="timer-controls">
        <button class="control-btn secondary danger" onclick="stopSession()" title="Termina">
          <i class="bi bi-stop-fill"></i>
        </button>
        <button class="control-btn primary" id="playPauseBtn" onclick="togglePause()">
          <i class="bi bi-pause-fill" id="playPauseIcon"></i>
        </button>
        <button class="control-btn secondary" onclick="addFiveMinutes()" title="+5 minuti">
          <i class="bi bi-plus-lg"></i>
        </button>
      </div>

      <!-- Next XP Milestone -->
      <div class="xp-info-box" style="margin-top: 0;">
        <i class="bi bi-clock"></i>
        Prossimi <strong>+3 XP</strong> tra <span id="nextMilestone">10:00</span>
      </div>
    </div>

  </div>

  <!-- XP Toast Container -->
  <div id="xpToastContainer"></div>

  <!-- Completion Modal -->
  <div class="completion-modal" id="completionModal">
    <div class="completion-content">
      <div class="completion-icon">üéâ</div>
      <h2 class="completion-title">Sessione Completata!</h2>
      <p class="completion-subtitle" id="completionSubtitle">Ottimo lavoro! Hai mantenuto il focus.</p>
      <div class="completion-stats">
        <div class="completion-stat">
          <div class="completion-stat-value" id="modalTime">25:00</div>
          <div class="completion-stat-label">Durata</div>
        </div>
        <div class="completion-stat">
          <div class="completion-stat-value" id="modalXp">+8</div>
          <div class="completion-stat-label">XP Totali</div>
        </div>
      </div>
      <div class="completion-buttons">
        <button class="btn btn-outline" onclick="goToDashboard()">
          <i class="bi bi-house"></i> Dashboard
        </button>
        <button class="btn btn-primary" onclick="startNewSession()">
          <i class="bi bi-arrow-repeat"></i> Nuova Sessione
        </button>
      </div>
    </div>
  </div>
</main>

<script src="js/layout.js"></script>
<script src="js/focus-manager.js"></script>
<script>
  // ==================== CONFIGURAZIONE XP ====================
  const XP_PER_INTERVAL = 3;      // XP guadagnati ogni intervallo
  const XP_INTERVAL_MINUTES = 10; // Intervallo in minuti
  const XP_COMPLETION_BONUS = 1;  // Bonus per completamento

  // ==================== STATO ====================
  let state = {
      selectedMinutes: 25,
      totalSeconds: 0,
      remainingSeconds: 0,
      elapsedSeconds: 0,
      earnedXp: 0,
      lastXpMilestone: 0,
      isRunning: false,
      isPaused: false,
      intervalId: null
  };

  // ==================== INIZIALIZZAZIONE ====================
  document.addEventListener('DOMContentLoaded', function() {
      initLayout({
          pageTitle: 'Modalit√† Focus',
          activePage: 'focus',
          showTopbar: true,
          showFooter: false
      });

      // Ripristina sessione attiva
      const savedState = localStorage.getItem('focusState');
      if (savedState) {
          const parsed = JSON.parse(savedState);
          if (parsed.isRunning) {
              state = parsed;
              showTimerScreen();
              updateTimerDisplay();
              updateStats();
              if (!state.isPaused) {
                  startInterval();
              }
              updateTimerUI();
          }
      }

      // Aggiorna XP preview iniziale
      updateXpPreview(25);
  });

  // ==================== SETUP FUNCTIONS ====================
  function selectDuration(minutes) {
      state.selectedMinutes = minutes;

      // Update UI
      document.querySelectorAll('.duration-option').forEach(el => {
          el.classList.remove('selected');
          if (parseInt(el.dataset.minutes) === minutes) {
              el.classList.add('selected');
          }
      });

      // Update slider
      document.getElementById('durationSlider').value = minutes;
      document.getElementById('customMinutes').textContent = minutes;
      document.getElementById('customDuration').classList.remove('active');

      // Update XP preview
      updateXpPreview(minutes);
  }

  function updateCustomDuration(minutes) {
      minutes = parseInt(minutes);
      state.selectedMinutes = minutes;

      document.getElementById('customMinutes').textContent = minutes;

      // Deselect preset options unless it matches
      document.querySelectorAll('.duration-option').forEach(el => {
          el.classList.remove('selected');
          if (parseInt(el.dataset.minutes) === minutes) {
              el.classList.add('selected');
          }
      });

      document.getElementById('customDuration').classList.add('active');
      updateXpPreview(minutes);
  }

  function updateXpPreview(minutes) {
      const xp = calculateXp(minutes);
      document.getElementById('xpPreview').textContent = xp;
  }

  function calculateXp(minutes) {
      // XP = (minuti / intervallo) * XP_per_intervallo + bonus completamento
      const intervalXp = Math.floor(minutes / XP_INTERVAL_MINUTES) * XP_PER_INTERVAL;
      return intervalXp + XP_COMPLETION_BONUS;
  }

  // ==================== SESSION CONTROL ====================
  function startFocusSession() {
      state.totalSeconds = state.selectedMinutes * 60;
      state.remainingSeconds = state.totalSeconds;
      state.elapsedSeconds = 0;
      state.earnedXp = 0;
      state.lastXpMilestone = 0;
      state.isRunning = true;
      state.isPaused = false;

      showTimerScreen();
      updateTimerDisplay();
      updateStats();
      startInterval();
      saveState();

      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
      }
  }

  function togglePause() {
      if (state.isPaused) {
          // Resume
          state.isPaused = false;
          startInterval();
      } else {
          // Pause
          state.isPaused = true;
          clearInterval(state.intervalId);
      }
      updateTimerUI();
      saveState();
  }

  function stopSession() {
      if (state.elapsedSeconds < 60) {
          // Meno di 1 minuto, chiedi conferma
          if (!confirm('Hai studiato meno di 1 minuto. Sei sicuro di voler terminare senza XP?')) {
              return;
          }
          // No XP se meno di 1 minuto
          state.earnedXp = 0;
      }

      clearInterval(state.intervalId);
      state.isRunning = false;

      // Salva XP guadagnati al backend
      if (state.earnedXp > 0) {
          recordFocusXp(state.earnedXp, Math.floor(state.elapsedSeconds / 60));
      }

      showCompletionModal();
      saveState();
  }

  function addFiveMinutes() {
      state.remainingSeconds += 5 * 60;
      state.totalSeconds += 5 * 60;
      updateTimerDisplay();
      showXpToast('+5 minuti aggiunti!', '');
  }

  function startInterval() {
      state.intervalId = setInterval(() => {
          if (state.remainingSeconds > 0) {
              state.remainingSeconds--;
              state.elapsedSeconds++;

              // Check XP milestone (ogni 10 minuti)
              const currentMilestone = Math.floor(state.elapsedSeconds / (XP_INTERVAL_MINUTES * 60));
              if (currentMilestone > state.lastXpMilestone) {
                  state.earnedXp += XP_PER_INTERVAL;
                  state.lastXpMilestone = currentMilestone;
                  showXpToast(`+${XP_PER_INTERVAL} XP`, '10 minuti di focus!');
                  playSound();
              }

              updateTimerDisplay();
              updateStats();
              saveState();
          } else {
              // Timer completato!
              sessionComplete();
          }
      }, 1000);
  }

  function sessionComplete() {
      clearInterval(state.intervalId);
      state.isRunning = false;

      // Bonus XP per completamento
      state.earnedXp += XP_COMPLETION_BONUS;
      showXpToast(`+${XP_COMPLETION_BONUS} XP Bonus`, 'Sessione completata!');

      // Notifica
      showNotification('üéØ Focus completato!', `Hai guadagnato +${state.earnedXp} XP`);
      playSound();

      // Salva al backend
      recordFocusXp(state.earnedXp, Math.floor(state.elapsedSeconds / 60));

      setTimeout(() => showCompletionModal(), 500);
      saveState();
  }

  // ==================== UI UPDATES ====================
  function showTimerScreen() {
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('timerScreen').classList.add('active');
  }

  function showSetupScreen() {
      document.getElementById('setupScreen').classList.remove('hidden');
      document.getElementById('timerScreen').classList.remove('active');
  }

  function updateTimerDisplay() {
      const minutes = Math.floor(state.remainingSeconds / 60);
      const seconds = state.remainingSeconds % 60;

      document.getElementById('timerDisplay').textContent =
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      // Progress ring
      const circumference = 2 * Math.PI * 150;
      const progress = state.remainingSeconds / state.totalSeconds;
      const offset = circumference * (1 - progress);
      document.getElementById('progressCircle').style.strokeDashoffset = offset;

      // Next milestone calculation
      const elapsedMinutes = state.elapsedSeconds / 60;
      const nextMilestoneMinutes = (Math.floor(elapsedMinutes / XP_INTERVAL_MINUTES) + 1) * XP_INTERVAL_MINUTES;
      const secondsToNext = (nextMilestoneMinutes * 60) - state.elapsedSeconds;

      if (secondsToNext > 0) {
          const nextMin = Math.floor(secondsToNext / 60);
          const nextSec = secondsToNext % 60;
          document.getElementById('nextMilestone').textContent =
              `${nextMin}:${nextSec.toString().padStart(2, '0')}`;
      } else {
          document.getElementById('nextMilestone').textContent = '0:00';
      }
  }

  function updateStats() {
      // Elapsed time
      const elapsedMin = Math.floor(state.elapsedSeconds / 60);
      const elapsedSec = state.elapsedSeconds % 60;
      document.getElementById('elapsedTime').textContent =
          `${elapsedMin}:${elapsedSec.toString().padStart(2, '0')}`;

      // Earned XP
      document.getElementById('earnedXp').textContent = state.earnedXp;
  }

  function updateTimerUI() {
      const timerCircle = document.getElementById('timerCircle');
      const timerLabel = document.getElementById('timerLabel');
      const playPauseIcon = document.getElementById('playPauseIcon');
      const playPauseBtn = document.getElementById('playPauseBtn');

      if (state.isPaused) {
          timerCircle.classList.add('paused');
          timerCircle.classList.remove('active');
          timerLabel.textContent = 'PAUSA';
          timerLabel.classList.add('paused');
          playPauseIcon.className = 'bi bi-play-fill';
          playPauseBtn.classList.add('paused');
      } else {
          timerCircle.classList.remove('paused');
          timerCircle.classList.add('active');
          timerLabel.textContent = 'FOCUS';
          timerLabel.classList.remove('paused');
          playPauseIcon.className = 'bi bi-pause-fill';
          playPauseBtn.classList.remove('paused');
      }
  }

  // ==================== MODALS & TOASTS ====================
  function showXpToast(text, subtext) {
      const container = document.getElementById('xpToastContainer');
      const toast = document.createElement('div');
      toast.className = 'xp-toast';
      toast.innerHTML = `
          <i class="bi bi-lightning-charge-fill"></i>
          <div>
              <div class="xp-toast-text">${text}</div>
              ${subtext ? `<small style="color: var(--text-muted);">${subtext}</small>` : ''}
          </div>
      `;
      container.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
  }

  function showCompletionModal() {
      const elapsedMin = Math.floor(state.elapsedSeconds / 60);
      const elapsedSec = state.elapsedSeconds % 60;

      document.getElementById('modalTime').textContent =
          `${elapsedMin}:${elapsedSec.toString().padStart(2, '0')}`;
      document.getElementById('modalXp').textContent = `+${state.earnedXp}`;

      const selectedMin = state.selectedMinutes;
      if (elapsedMin >= selectedMin) {
          document.getElementById('completionSubtitle').textContent =
              'Ottimo lavoro! Hai completato l\'intera sessione.';
      } else {
          document.getElementById('completionSubtitle').textContent =
              `Hai mantenuto il focus per ${elapsedMin} minuti.`;
      }

      document.getElementById('completionModal').classList.add('show');
  }

  function goToDashboard() {
      FocusManager.endSession();
      window.location.href = 'dashboard.html';
  }

  function startNewSession() {
      document.getElementById('completionModal').classList.remove('show');
      FocusManager.endSession();
      state = {
          selectedMinutes: 25,
          totalSeconds: 0,
          remainingSeconds: 0,
          elapsedSeconds: 0,
          earnedXp: 0,
          lastXpMilestone: 0,
          isRunning: false,
          isPaused: false,
          intervalId: null
      };
      showSetupScreen();
  }

  // ==================== NOTIFICATIONS & SOUND ====================
  function showNotification(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(title, { body, icon: '/images/logo.png' });
      }
  }

  function playSound() {
      try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.frequency.value = 800;
          gain.gain.value = 0.3;

          osc.start();
          osc.stop(ctx.currentTime + 0.2);
      } catch (e) {}
  }

  // ==================== PERSISTENCE ====================
  function saveState() {
      localStorage.setItem('focusState', JSON.stringify({
          ...state,
          intervalId: null
      }));
  }

  // ==================== API ====================
  async function recordFocusXp(xpEarned, durationMinutes) {
      try {
          const token = localStorage.getItem('token');
          if (!token) return;

          const response = await fetch('/api/gamification/focus-session', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                  durationMinutes,
                  xpEarned
              })
          });

          if (response.ok) {
              console.log('Focus session recorded:', xpEarned, 'XP');
          }
      } catch (error) {
          console.error('Errore salvataggio sessione:', error);
      }
  }

  // ==================== PREVENT ACCIDENTAL CLOSE ====================
  window.addEventListener('beforeunload', (e) => {
      if (state.isRunning && !state.isPaused) {
          e.preventDefault();
          e.returnValue = 'Il timer √® attivo. Sei sicuro di voler uscire?';
      }
  });
</script>
</body>
</html>