<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classifica - AI Study Buddy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Leaderboard specific styles */
    .leaderboard-tabs {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .leaderboard-tab {
        flex: 1;
        min-width: 120px;
        padding: 1rem;
        border-radius: 1rem;
        background: var(--dark-card);
        border: 2px solid var(--dark-border);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .leaderboard-tab:hover {
        border-color: var(--primary-color);
        color: var(--text-primary);
    }

    .leaderboard-tab.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .leaderboard-tab i {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .leaderboard-tab span {
        font-weight: 600;
        font-size: 0.85rem;
    }

    /* My Rank Card */
    .my-rank-card {
        background: var(--dark-card);
        border: 2px solid var(--primary-color);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .my-rank-position {
        font-size: 3rem;
        font-weight: 800;
        color: var(--primary-color);
    }

    .my-rank-info {
        flex: 1;
        min-width: 150px;
    }

    .my-rank-info h4 {
        margin: 0 0 0.25rem;
        color: var(--text-primary);
    }

    .my-rank-info p {
        margin: 0;
        color: var(--text-muted);
    }

    .my-rank-stats {
        text-align: right;
    }

    .my-rank-xp {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .my-rank-level {
        color: var(--text-muted);
        font-size: 0.875rem;
    }

    /* Podium */
    .podium-container {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
    }

    .podium-item {
        text-align: center;
        background: var(--dark-card);
        border: 2px solid var(--dark-border);
        border-radius: 1rem;
        padding: 1.5rem 1rem;
        transition: all 0.3s ease;
        width: 160px;
    }

    .podium-item:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
    }

    .podium-1 {
        order: 2;
        transform: scale(1.1);
        z-index: 2;
        border-color: #ffd700;
        background: linear-gradient(135deg, var(--dark-card) 0%, rgba(255, 215, 0, 0.1) 100%);
    }

    .podium-1:hover {
        transform: scale(1.1) translateY(-5px);
    }

    .podium-2 { order: 1; }
    .podium-3 { order: 3; }

    .podium-crown {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .podium-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        margin: 0 auto 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: #1a1a2e;
    }

    .podium-1 .podium-avatar {
        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        width: 80px;
        height: 80px;
        box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
    }

    .podium-2 .podium-avatar {
        background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%);
    }

    .podium-3 .podium-avatar {
        background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
        color: white;
    }

    .podium-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .podium-value {
        font-weight: 700;
        color: var(--primary-color);
    }

    /* Leaderboard List */
    .leaderboard-card {
        background: var(--dark-card);
        border: 2px solid var(--dark-border);
        border-radius: 1rem;
        overflow: hidden;
    }

    .leaderboard-item {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--dark-border);
        transition: all 0.2s ease;
    }

    .leaderboard-item:last-child {
        border-bottom: none;
    }

    .leaderboard-item:hover {
        background: rgba(139, 92, 246, 0.1);
    }

    .leaderboard-item.current-user {
        background: rgba(139, 92, 246, 0.15);
        border-left: 4px solid var(--primary-color);
    }

    .leaderboard-rank {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
        margin-right: 1rem;
        flex-shrink: 0;
        background: var(--dark-border);
        color: var(--text-secondary);
    }

    .leaderboard-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .leaderboard-user {
        flex: 1;
        min-width: 0;
    }

    .leaderboard-user-name {
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .leaderboard-user-level {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .leaderboard-value {
        text-align: right;
        flex-shrink: 0;
    }

    .leaderboard-value-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .leaderboard-value-label {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .badge-you {
        background: var(--primary-color);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
    }

    /* Loading & Empty States */
    .loading-state,
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .loading-state i,
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .podium-container {
            flex-direction: column;
            align-items: center;
        }

        .podium-1, .podium-2, .podium-3 {
            order: unset;
            transform: none;
            width: 100%;
            max-width: 280px;
        }

        .podium-1:hover {
            transform: translateY(-5px);
        }

        .my-rank-card {
            flex-direction: column;
            text-align: center;
        }

        .my-rank-stats {
            text-align: center;
        }

        .leaderboard-tabs {
            flex-direction: column;
        }

        .leaderboard-tab {
            flex-direction: row;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .leaderboard-tab i {
            margin-bottom: 0;
        }
    }
  </style>
</head>
<body>
<div class="main-content" id="mainContent">
  <!-- Content will be injected here -->
</div>

<script src="js/app.js"></script>
<script src="js/layout.js"></script>
<script>
  let currentUserId = null;

  document.addEventListener('DOMContentLoaded', function() {
      // Inizializza layout
      initLayout({
          pageTitle: 'Classifica',
          pageSubtitle: 'Confrontati con gli altri studenti',
          activePage: 'leaderboard'
      });

      // Carica contenuto
      renderLeaderboardPage();
      loadUserStats();
      loadLeaderboard('XP');
  });

  function renderLeaderboardPage() {
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML += `
          <!-- My Rank Card -->
          <div class="my-rank-card">
              <div class="my-rank-position" id="myRankPosition">#-</div>
              <div class="my-rank-info">
                  <h4>La tua posizione</h4>
                  <p id="myRankDetails">Caricamento...</p>
              </div>
              <div class="my-rank-stats">
                  <div class="my-rank-xp" id="myXp">0 XP</div>
                  <div class="my-rank-level">Livello <span id="myLevel">1</span></div>
              </div>
          </div>

          <!-- Tabs -->
          <div class="leaderboard-tabs">
              <button class="leaderboard-tab active" data-type="XP" onclick="loadLeaderboard('XP', this)">
                  <i class="bi bi-lightning-charge-fill"></i>
                  <span>XP Totali</span>
              </button>
              <button class="leaderboard-tab" data-type="WEEKLY_XP" onclick="loadLeaderboard('WEEKLY_XP', this)">
                  <i class="bi bi-calendar-week"></i>
                  <span>Settimana</span>
              </button>
              <button class="leaderboard-tab" data-type="STREAK" onclick="loadLeaderboard('STREAK', this)">
                  <i class="bi bi-fire"></i>
                  <span>Streak</span>
              </button>
          </div>

          <!-- Podium -->
          <div class="podium-container" id="podiumContainer">
              <div class="loading-state">
                  <div class="loading-spinner"></div>
                  <p>Caricamento podio...</p>
              </div>
          </div>

          <!-- Leaderboard List -->
          <div class="leaderboard-card" id="leaderboardContainer">
              <div class="loading-state">
                  <div class="loading-spinner"></div>
                  <p>Caricamento classifica...</p>
              </div>
          </div>
      `;
  }

  async function loadUserStats() {
      try {
          const token = localStorage.getItem('token');
          if (!token) return;

          // Ottieni user ID dal localStorage
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          currentUserId = user.id;

          // Carica stats
          const response = await fetch('/api/gamification/stats', {
              headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.ok) {
              const stats = await response.json();
              document.getElementById('myXp').textContent = `${(stats.totalXp || 0).toLocaleString()} XP`;
              document.getElementById('myLevel').textContent = stats.level || 1;
          }
      } catch (error) {
          console.error('Errore caricamento stats:', error);
      }
  }

  async function loadLeaderboard(type, btn = null) {
      // Aggiorna tab attivo
      if (btn) {
          document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
      }

      const token = localStorage.getItem('token');
      if (!token) {
          window.location.href = 'login.html';
          return;
      }

      try {
          // Carica leaderboard e rank in parallelo
          const [leaderboardResponse, rankResponse] = await Promise.all([
              fetch(`/api/gamification/leaderboard/${type}?limit=20`, {
                  headers: { 'Authorization': `Bearer ${token}` }
              }),
              fetch(`/api/gamification/leaderboard/${type}/my-rank`, {
                  headers: { 'Authorization': `Bearer ${token}` }
              })
          ]);

          let entries = [];
          let myRank = -1;

          if (leaderboardResponse.ok) {
              entries = await leaderboardResponse.json();
          }

          if (rankResponse.ok) {
              myRank = await rankResponse.json();
          }

          updateMyRankCard(myRank, type);
          renderPodium(entries.slice(0, 3), type);
          renderLeaderboard(entries, type);

      } catch (error) {
          console.error('Errore caricamento leaderboard:', error);
          document.getElementById('podiumContainer').innerHTML = `
              <div class="empty-state">
                  <i class="bi bi-exclamation-circle"></i>
                  <p>Errore nel caricamento</p>
              </div>
          `;
      }
  }

  function updateMyRankCard(rank, type) {
      const positionEl = document.getElementById('myRankPosition');
      const detailsEl = document.getElementById('myRankDetails');

      positionEl.textContent = rank > 0 ? `#${rank}` : '#-';

      let message = '';
      if (rank === 1) {
          message = 'üèÜ Sei in testa alla classifica!';
      } else if (rank <= 3) {
          message = 'ü•á Fantastico! Sei sul podio!';
      } else if (rank <= 10) {
          message = '‚≠ê Ottimo! Sei nella Top 10!';
      } else if (rank > 0) {
          message = `Continua cos√¨ per scalare la classifica!`;
      } else {
          message = 'Completa attivit√† per entrare in classifica';
      }

      detailsEl.textContent = message;
  }

  function renderPodium(topThree, type) {
      const container = document.getElementById('podiumContainer');

      if (!topThree || topThree.length < 3) {
          container.innerHTML = `
              <div class="empty-state">
                  <i class="bi bi-trophy"></i>
                  <p>Non ci sono ancora abbastanza partecipanti</p>
              </div>
          `;
          return;
      }

      const valueLabel = type === 'STREAK' ? 'üî•' : 'XP';
      const medals = ['ü•á', 'ü•à', 'ü•â'];

      // Ordine: 2¬∞, 1¬∞, 3¬∞ per il layout podio
      const order = [1, 0, 2];

      container.innerHTML = order.map(idx => {
          const entry = topThree[idx];
          const pos = idx + 1;
          const isCurrentUser = entry.userId === currentUserId;
          const initials = getInitials(entry.userName);

          return `
              <div class="podium-item podium-${pos} ${isCurrentUser ? 'current-user' : ''}">
                  ${pos === 1 ? '<div class="podium-crown">üëë</div>' : ''}
                  <div class="podium-avatar">${medals[pos - 1]}</div>
                  <div class="podium-name">${entry.userName || 'Utente'}${isCurrentUser ? ' (Tu)' : ''}</div>
                  <div class="podium-value">${(entry.value || 0).toLocaleString()} ${valueLabel}</div>
              </div>
          `;
      }).join('');
  }

  function renderLeaderboard(entries, type) {
      const container = document.getElementById('leaderboardContainer');

      if (!entries || entries.length === 0) {
          container.innerHTML = `
              <div class="empty-state">
                  <i class="bi bi-people"></i>
                  <p>Nessun partecipante in classifica</p>
              </div>
          `;
          return;
      }

      // Mostra dal 4¬∞ posto in poi
      const listEntries = entries.slice(3);
      const valueLabel = type === 'STREAK' ? 'giorni' : 'XP';

      if (listEntries.length === 0) {
          container.innerHTML = `
              <div class="empty-state">
                  <i class="bi bi-emoji-smile"></i>
                  <p>Solo il podio √® disponibile per ora</p>
              </div>
          `;
          return;
      }

      container.innerHTML = listEntries.map((entry, idx) => {
          const rank = idx + 4;
          const isCurrentUser = entry.userId === currentUserId;
          const initials = getInitials(entry.userName);

          return `
              <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                  <div class="leaderboard-rank">${rank}</div>
                  <div class="leaderboard-avatar">${initials}</div>
                  <div class="leaderboard-user">
                      <div class="leaderboard-user-name">
                          ${entry.userName || 'Utente'}
                          ${isCurrentUser ? '<span class="badge-you">Tu</span>' : ''}
                      </div>
                      <div class="leaderboard-user-level">Livello ${entry.level || 1}</div>
                  </div>
                  <div class="leaderboard-value">
                      <div class="leaderboard-value-number">${(entry.value || 0).toLocaleString()}</div>
                      <div class="leaderboard-value-label">${valueLabel}</div>
                  </div>
              </div>
          `;
      }).join('');
  }

  function getInitials(name) {
      if (!name) return 'U';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
          return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
      }
      return name.charAt(0).toUpperCase();
  }
</script>
</body>
</html>